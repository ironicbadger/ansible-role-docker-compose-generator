---
- name: ensure destination for compose file exists
  file:
    path: "{{ docker_compose_generator_output_path }}"
    state: directory

- name: Find all compose files
  set_fact:
    compose_files: >-
      {{
        query('filetree', playbook_dir + '/services/' +
          (docker_compose_hostname | default(inventory_hostname))) |
        selectattr('state', 'eq', 'file') |
        selectattr('path', 'regex', 'compose.ya?ml$') |
        list
      }}

- name: Build combined compose content
  set_fact:
    combined_compose: |
      # Generated by ironicbadger.docker-compose-generator
      # badger badger badger badger badger mushrooooom...
      ---
      services:
      {% for file in compose_files %}
      {{
        lookup('template', file.src) |
        regex_replace('^---\s*\n*services:\s*\n', '') |
        regex_replace('^\s*services:\s*\n', '') |
        regex_replace('^(\S)', '  \1')
      }}
      {% endfor %}

- name: Write combined compose file
  copy:
    content: "{{ combined_compose }}"
    dest: "{{ docker_compose_generator_output_path }}/compose.yaml"
    owner: "{{ docker_compose_generator_uid }}"
    group: "{{ docker_compose_generator_gid }}"