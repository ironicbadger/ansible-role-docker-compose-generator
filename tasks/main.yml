---
- name: ensure destination for compose file exists
  file:
    path: "{{ docker_compose_generator_output_path }}"
    state: directory

- name: Find all compose files
  set_fact:
    compose_files: >-
      {{
        query('filetree', services_directory +
          (docker_compose_hostname | default(inventory_hostname))) |
        selectattr('state', 'eq', 'file') |
        selectattr('path', 'regex', '.ya?ml$') |
        rejectattr('path', 'regex', 'config-[^/]+/') |
        list
      }}

- name: Build combined compose content
  set_fact:
    combined_compose: |
      # Generated by ironicbadger.docker-compose-generator
      # badger badger badger mushroom mushrooooom...

      services:
      {% for file in compose_files | sort(attribute='src') %}
      {% set service_name = file.src | dirname | basename %}
      {% if service_name not in (disabled_compose_files | default([])) %}
      {{ lookup('template', file.src)
         | regex_replace('^(---|services:)\s*\n*', '')
         | regex_replace('^', '  ') }}
      {% endif %}
      {% endfor %}

- name: Write combined compose file
  copy:
    content: "{{ combined_compose }}"
    dest: "{{ docker_compose_generator_output_path }}/compose.yaml"
    owner: "{{ docker_compose_generator_uid }}"
    group: "{{ docker_compose_generator_gid }}"

- name: Find all config directories
  find:
    paths: "{{ services_directory }}{{ docker_compose_hostname | default(inventory_hostname) }}"
    patterns: "config-*"
    file_type: directory
    recurse: yes
  delegate_to: localhost
  register: config_dirs

- name: Deploy config files from config-* directories
  include_tasks: deploy-config.yml
  loop: "{{ config_dirs.files }}"
  loop_control:
    loop_var: config_dir
  when: config_dirs.files | length > 0