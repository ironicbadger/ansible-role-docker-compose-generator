---
- name: Ensure destination for compose file exists
  ansible.builtin.file:
    path: "{{ docker_compose_generator_output_path }}"
    state: directory
    mode: "0755"

- name: Find all compose files
  ansible.builtin.set_fact:
    compose_files: >-
      {{
        query('filetree', services_directory +
          (docker_compose_hostname | default(inventory_hostname))) |
        selectattr('state', 'eq', 'file') |
        selectattr('path', 'regex', '.ya?ml$') |
        sort(attribute='src') |
        list
      }}

- name: Filter out disabled compose files
  ansible.builtin.set_fact:
    compose_files: >-
      {{
        compose_files | rejectattr('path', 'contains', disabled_item) | list
      }}
  loop: "{{ disabled_compose_files if disabled_compose_files is not none else [] }}"
  loop_control:
    loop_var: disabled_item

- name: Extract data from compose files
  ansible.builtin.include_tasks:
    file: extract-data.yml
  loop:
    - services
    - networks
    - volumes
    - configs
    - secrets
  loop_control:
    loop_var: compose_section

- name: Build combined compose content
  ansible.builtin.set_fact:
    combined_compose: |
      # Generated by ironicbadger.docker-compose-generator
      # badger badger badger mushroom mushrooooom...

      {{ {'services': extracted_services} | to_nice_yaml(indent=2, width=1000, sort_keys=False) }}
      {{ {'networks': extracted_networks} | to_nice_yaml(indent=2, width=1000, sort_keys=False) }}
      {{ {'volumes': extracted_volumes} | to_nice_yaml(indent=2, width=1000, sort_keys=False) }}
      {{ {'configs': extracted_configs} | to_nice_yaml(indent=2, width=1000, sort_keys=False) }}
      {{ {'secrets': extracted_secrets} | to_nice_yaml(indent=2, width=1000, sort_keys=False) }}

- name: Write combined compose file
  ansible.builtin.copy:
    content: "{{ combined_compose }}"
    dest: "{{ docker_compose_generator_output_path }}/compose.yaml"
    owner: "{{ docker_compose_generator_uid }}"
    group: "{{ docker_compose_generator_gid }}"
    mode: "0644"
