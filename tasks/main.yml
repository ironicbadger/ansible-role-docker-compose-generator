---
- name: ensure destination for compose file exists
  file:
    path: "{{ docker_compose_generator_output_path }}"
    state: directory

- name: Find all compose files
  set_fact:
    compose_files: >-
      {{
        query('filetree', services_directory +
          (docker_compose_hostname | default(inventory_hostname))) |
        selectattr('state', 'eq', 'file') |
        selectattr('path', 'regex', '.ya?ml$') |
        rejectattr('path', 'regex', 'config-[^/]+/') |
        list
      }}

- name: Parse all compose files
  set_fact:
    parsed_compose_files: "{{ parsed_compose_files | default([]) + [lookup('template', item.src) | from_yaml] }}"
  loop: "{{ compose_files | sort(attribute='src') }}"
  loop_control:
    label: "{{ item.src | basename }}"
  when: (item.src | dirname | basename) not in (disabled_compose_files | default([]))
  no_log: true

- name: Merge all configs sections
  set_fact:
    all_configs: "{{ all_configs | default({}) | combine(item.configs | default({})) }}"
  loop: "{{ parsed_compose_files }}"
  loop_control:
    label: "configs"
  no_log: true

- name: Merge all networks sections
  set_fact:
    all_networks: "{{ all_networks | default({}) | combine(item.networks | default({})) }}"
  loop: "{{ parsed_compose_files }}"
  loop_control:
    label: "networks"
  no_log: true

- name: Merge all volumes sections
  set_fact:
    all_volumes: "{{ all_volumes | default({}) | combine(item.volumes | default({})) }}"
  loop: "{{ parsed_compose_files }}"
  loop_control:
    label: "volumes"
  no_log: true

- name: Merge all secrets sections
  set_fact:
    all_secrets: "{{ all_secrets | default({}) | combine(item.secrets | default({})) }}"
  loop: "{{ parsed_compose_files }}"
  loop_control:
    label: "secrets"
  no_log: true

- name: Merge all services sections
  set_fact:
    all_services: "{{ all_services | default({}) | combine(item.services | default({})) }}"
  loop: "{{ parsed_compose_files }}"
  loop_control:
    label: "services"
  no_log: true

- name: Build combined compose content
  set_fact:
    combined_compose_raw: |
      # Generated by ironicbadger.docker-compose-generator
      # badger badger badger mushroom mushrooooom...

      {% if all_configs %}
      configs:
        {{ all_configs | to_nice_yaml(indent=2) | indent(2) | trim }}
      {% endif %}
      {% if all_networks %}
      networks:
        {{ all_networks | to_nice_yaml(indent=2) | indent(2) | trim }}
      {% endif %}
      {% if all_volumes %}
      volumes:
        {{ all_volumes | to_nice_yaml(indent=2) | indent(2) | trim }}
      {% endif %}
      {% if all_secrets %}
      secrets:
        {{ all_secrets | to_nice_yaml(indent=2) | indent(2) | trim }}
      {% endif %}
      services:
        {{ all_services | to_nice_yaml(indent=2) | indent(2) | trim }}
  no_log: true

- name: Fix list indentation for better readability
  set_fact:
    combined_compose: "{{ combined_compose_raw | indent_yaml_lists }}"
  no_log: true

- name: Write combined compose file
  copy:
    content: "{{ combined_compose }}"
    dest: "{{ docker_compose_generator_output_path }}/compose.yaml"
    owner: "{{ docker_compose_generator_uid }}"
    group: "{{ docker_compose_generator_gid }}"
  no_log: true

- name: Find all config directories
  find:
    paths: "{{ services_directory }}{{ docker_compose_hostname | default(inventory_hostname) }}"
    patterns: "config-*"
    file_type: directory
    recurse: yes
  delegate_to: localhost
  register: config_dirs

- name: Deploy config files from config-* directories
  include_tasks: deploy-config.yml
  loop: "{{ config_dirs.files }}"
  loop_control:
    loop_var: config_dir
  when: config_dirs.files | length > 0